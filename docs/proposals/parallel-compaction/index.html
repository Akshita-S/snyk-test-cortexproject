<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.72.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Parallel Compaction by Time Interval | Cortex</title><meta property="og:title" content="Parallel Compaction by Time Interval"><meta property="og:description" content="Author: Roy Chiang Date: May 2021 Status: Proposed   Introduction As a part of pushing Cortex’s scaling capability at AWS, we have done performance testing with Cortex and found the compactor to be one of the main limiting factors for higher active timeseries limit per tenant. The documentation Compactor describes the responsibilities of a compactor, and this proposal focuses on the limitations of the current compactor architecture. In the current architecture, compactor has simple sharding, meaning that a single tenant is sharded to a single compactor."><meta property="og:type" content="article"><meta property="og:url" content="/docs/proposals/parallel-compaction/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Parallel Compaction by Time Interval"><meta itemprop=description content="Author: Roy Chiang Date: May 2021 Status: Proposed   Introduction As a part of pushing Cortex’s scaling capability at AWS, we have done performance testing with Cortex and found the compactor to be one of the main limiting factors for higher active timeseries limit per tenant. The documentation Compactor describes the responsibilities of a compactor, and this proposal focuses on the limitations of the current compactor architecture. In the current architecture, compactor has simple sharding, meaning that a single tenant is sharded to a single compactor."><meta itemprop=wordCount content="1044"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Parallel Compaction by Time Interval"><meta name=twitter:description content="Author: Roy Chiang Date: May 2021 Status: Proposed   Introduction As a part of pushing Cortex’s scaling capability at AWS, we have done performance testing with Cortex and found the compactor to be one of the main limiting factors for higher active timeseries limit per tenant. The documentation Compactor describes the responsibilities of a compactor, and this proposal focuses on the limitations of the current compactor architecture. In the current architecture, compactor has simple sharding, meaning that a single tenant is sharded to a single compactor."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-63872299-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.1b84fb3448b3a919a5f3243ccd81594364920ce63a1333a3c0930e885e4895f8.css as=style><link href=/scss/main.min.1b84fb3448b3a919a5f3243ccd81594364920ce63a1333a3c0930e885e4895f8.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Parallel Compaction by Time Interval | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149q7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705q24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12q11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953 56.796 56.796.0 00-19.079 13.875 63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873q11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 017.433-11.52 34.013 34.013.0 0111.272-7.803 36.694 36.694.0 0114.74-2.85 36.062 36.062.0 0114.494 2.85 36.492 36.492.0 0111.398 7.68 36.107 36.107.0 017.68 11.52 43.253 43.253.0 013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this site…" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=docsgetting-started></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsarchitecture href=/docs/architecture/>Architecture</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/blocks-storage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Blocks Storage</a></li><ul><li class=collapse id=docsblocks-storage><a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier href=/docs/blocks-storage/querier/>Querier</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway href=/docs/blocks-storage/store-gateway/>Store-gateway</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor href=/docs/blocks-storage/compactor/>Compactor</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips href=/docs/blocks-storage/production-tips/>Production tips</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header href=/docs/blocks-storage/binary-index-header/>Binary index-header</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebucket-index href=/docs/blocks-storage/bucket-index/>Bucket Index</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/>Migrate Cortex cluster from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/>Convert long-term storage from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/>Migrate the storage from Thanos and Prometheus</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagelearn-more href=/docs/blocks-storage/learn-more/>Learn more</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/chunks-storage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Chunks Storage (deprecated and pending removal)</a></li><ul><li class=collapse id=docschunks-storage><a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storagegetting-started-chunks-storage href=/docs/chunks-storage/getting-started-chunks-storage/>Getting started with chunks storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storagerunning-chunks-storage-in-production href=/docs/chunks-storage/running-chunks-storage-in-production/>Running Cortex chunks storage in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storagerunning-chunks-storage-with-cassandra href=/docs/chunks-storage/running-chunks-storage-with-cassandra/>Running Cortex chunks storage with Cassandra</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storageschema-configuration href=/docs/chunks-storage/schema-configuration/>Schema Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storagetable-manager href=/docs/chunks-storage/table-manager/>Table-manager</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storagecaching href=/docs/chunks-storage/caching/>Caching</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storageingesters-with-wal href=/docs/chunks-storage/ingesters-with-wal/>Ingesters with WAL</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschunks-storageaws-tips href=/docs/chunks-storage/aws-tips/>AWS tips</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docsconfiguration><a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file href=/docs/configuration/configuration-file/>Configuration file</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees href=/docs/configuration/v1guarantees/>v1.x Guarantees</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class=collapse id=docsguides><a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesrunning-cortex-on-kubernetes href=/docs/guides/running-cortex-on-kubernetes/>Running Cortex on Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesgetting-started-with-gossiped-ring href=/docs/guides/getting-started-with-gossiped-ring/>Getting started with a gossip ring cluster</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesalertmanager-configuration href=/docs/guides/alertmanager-configuration/>Alertmanager configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesauth href=/docs/guides/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning href=/docs/guides/capacity-planning/>Capacity Planning</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding href=/docs/guides/ruler-sharding/>Config for horizontally scaling the Ruler</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesha-pair-handling href=/docs/guides/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesdeleting-series href=/docs/guides/deleting-series/>Deleting Series</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesencryption-at-rest href=/docs/guides/encryption-at-rest/>Encryption at Rest</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesgrpc-based-plugin href=/docs/guides/grpc-based-plugin/>gRPC storage plugin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates href=/docs/guides/ingesters-rolling-updates/>Ingesters rolling updates</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-scaling-up-and-down href=/docs/guides/ingesters-scaling-up-and-down/>Ingesters scaling up and down</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesoverrides-exporter href=/docs/guides/overrides-exporter/>Overrides Exporter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidestls href=/docs/guides/tls/>Securing communication between Cortex components with TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidessecurity href=/docs/guides/security/>Security</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding href=/docs/guides/shuffle-sharding/>Shuffle Sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing href=/docs/guides/tracing/>Tracing</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication href=/docs/guides/zone-aware-replication/>Zone Aware Replication</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideslimitations href=/docs/guides/limitations/>Limitations</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesglossary href=/docs/guides/glossary/>Glossary</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/api/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">HTTP API</a></li><ul><li class=collapse id=docsapi></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/operations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Operations</a></li><ul><li class=collapse id=docsoperations><a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor href=/docs/operations/query-auditor/>Query Auditor (tool)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee href=/docs/operations/query-tee/>Query Tee (service)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster href=/docs/operations/requests-mirroring-to-secondary-cluster/>Requests mirroring to secondary cluster</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend href=/docs/operations/scaling-query-frontend/>Scaling the Query Frontend</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/case-studies/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Case Studies</a></li><ul><li class=collapse id=docscase-studies><a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek href=/docs/case-studies/gojek/>Gojek</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital href=/docs/case-studies/rewe-digital/>REWE digital</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesbuoyant-cloud href=/docs/case-studies/buoyant-cloud/>Buoyant Cloud</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/proposals/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Proposals</a></li><ul><li class="collapse show" id=docsproposals><a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-bucket-index href=/docs/proposals/blocks-storage-bucket-index/>Blocks storage bucket index</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding href=/docs/proposals/blocks-storage-sharding/>Blocks storage sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalscross-tenant-query-federation href=/docs/proposals/cross-tenant-query-federation/>Cross-Tenant Query Federation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-deletion href=/docs/proposals/tenant-deletion/>Deletion of Tenant Data from Blocks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning href=/docs/proposals/documentation-versioning/>Documentation Versioning</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules href=/docs/proposals/generalize-modules/>Generalize Modules Service to make it extensible</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design href=/docs/proposals/http-api-design/>HTTP API Design</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration href=/docs/proposals/ingesters-migration/>Migrating ingesters from chunks to blocks and back.</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-docsproposalsparallel-compaction href=/docs/proposals/parallel-compaction/>Parallel Compaction by Time Interval</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalstenant-retention href=/docs/proposals/tenant-retention/>Retention of Tenant Data from Blocks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsruler-tenant-federation href=/docs/proposals/ruler-tenant-federation/>Ruler Tenant Federation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-alertmanager href=/docs/proposals/scalable-alertmanager/>Scalable Alertmanager</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend href=/docs/proposals/scalable-query-frontend/>Scalable Query Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness href=/docs/proposals/shuffle-sharding-and-zone-awareness/>Shuffle sharding and zone awareness</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path href=/docs/proposals/shuffle-sharding-on-the-read-path/>Shuffle sharding on the read path</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api href=/docs/proposals/support-metadata-api/>Support metadata API</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblock-storage-time-series-deletion href=/docs/proposals/block-storage-time-series-deletion/>Time Series Deletion from Blocks Storage</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=docscontributing><a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinggovernance href=/docs/contributing/governance/>Governance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions href=/docs/contributing/design-patterns-and-code-conventions/>Design patterns and Code conventions</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally href=/docs/contributing/how-to-run-the-website-locally/>How to run the website locally</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version href=/docs/contributing/how-to-upgrade-golang-version/>How to upgrade Golang version</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work href=/docs/contributing/how-integration-tests-work/>How integration tests work</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image href=/docs/contributing/how-to-update-the-build-image/>How to update the build image</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-add-a-maintainer href=/docs/contributing/how-to-add-a-maintainer/>How to add a maintainer</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsroadmap href=/docs/roadmap/>Roadmap</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docschangelog href=/docs/changelog/>Changelog</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/proposals/parallel-compaction.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Parallel%20Compaction%20by%20Time%20Interval" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#problem-and-requirements>Problem and Requirements</a></li></ul></li><li><a href=#design>Design</a><ul><li><a href=#parallelize-work>Parallelize Work</a></li></ul></li><li><a href=#scenarios>Scenarios</a><ul><li><a href=#bad-block-resulting-in-non-ideal-compaction-groups>Bad block resulting in non-ideal compaction groups</a></li></ul></li><li><a href=#alternatives>Alternatives</a><ul><li><a href=#shard-compaction-jobs-amongst-compactors-with-a-scheduler>Shard compaction jobs amongst compactors with a scheduler</a></li><li><a href=#contribute-to-thanos-for-a-more-scalable-compactor>Contribute to Thanos for a more scalable compactor</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/proposals/>Proposals</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/proposals/parallel-compaction/>Parallel Compaction by Time Interval</a></li></ol></nav><div class=td-content><h1>Parallel Compaction by Time Interval</h1><ul><li>Author: <a href=https://github.com/roystchiang>Roy Chiang</a></li><li>Date: May 2021</li><li>Status: Proposed</li></ul><hr><h2 id=introduction>Introduction</h2><p>As a part of pushing Cortex’s scaling capability at AWS, we have done performance testing with Cortex and found the compactor to be one of the main limiting factors for higher active timeseries limit per tenant. The documentation <a href=https://cortexmetrics.io/docs/blocks-storage/compactor/#how-compaction-works>Compactor</a> describes the responsibilities of a compactor, and this proposal focuses on the limitations of the current compactor architecture. In the current architecture, compactor has simple sharding, meaning that a single tenant is sharded to a single compactor. The compactor generates compaction groups, which are groups of Prometheus TSDB blocks that can be compacted together, independently of another group. However, a compactor currnetly handles compaction groups of a single tenant iteratively, meaning that blocks belonging non-overlapping times are not compacted in parallel.</p><p>Cortex ingesters are responsible for uploading TSDB blocks with data emitted by a tenant. These blocks are considered as level-1 blocks, as they contain duplicate timeseries for the same time interval, depending on the replication factor. <a href=https://cortexmetrics.io/docs/blocks-storage/compactor/#how-compaction-works>Vertical compaction</a> is done to merge all the blocks with the same time interval and deduplicate the samples. These merged blocks are level-2 blocks. Subsequent compactions such as horizontal compaction can happen, further increasing the compaction level of the blocks.</p><h3 id=problem-and-requirements>Problem and Requirements</h3><p>Currently, a compactor is able to compact up to 20M timeseries within 2 hours for a level-2 compaction, including the time to download blocks, compact, and upload the newly compacted block. We would like to increase the timeseries limit per tenant, and compaction is one of the limiting factors. In addition, we would like to achieve the following:</p><ul><li>Compact multiple non-overlapping time intervals concurrently, so we can achieve higher throughput for the compaction of a single tenant</li><li>We should be able to scale up, down compactor as needed, depending on how many compactions are pending</li><li>Insight into the compaction progress of a tenant, such as the number of compactions required in order to catch up to the newest blocks</li></ul><h2 id=design>Design</h2><p>We accept the fact that a single compaction can potentially take more than 2 hours to compact, and we achieve higher compaction throughput through horizontally scaling the compactor. To compact more blocks in parallel for a single tenant, we distribute the compaction groups to compactors, instead of introducing more parallelism within a compactor.</p><h3 id=parallelize-work>Parallelize Work</h3><p>This proposal builds heavily on top of the <a href=https://github.com/cortexproject/cortex/pull/2616>GrafanaLabs approach of introducing parallelism via time intervals</a>. The difference being that a single tenant is now sharded across multiple compactors instead of just a single compactor. The initial approach will be to work on distinct time intervals, but the compactor planner can be later extended to introduce parallelism within a time interval as well.</p><p>The following is an example of parallelize work at each level:</p><p><img src=/images/proposals/parallel-compaction-grouping.png alt="Parallel Compaction Grouping"></p><p>Compactors are shuffle-sharded, meaning that 1 tenant can belong to multiple compactors, and these subset of compactors determine which blocks should be compacted together. Compactors determine amongst themselves the responsibility of the compaction blocks, by using a hash of time interval and tenant id, and putting it on the sharding ring.</p><p>The benefit of this approach is that this aligns with what Cortex currently does in Ruler. The downside is that a compaction job can only be assigned to a single compactor, rather than all of the compactors sharded for the tenant. If a compaction job takes forever, other tenants sharded to the same compactor will be blocked until the issue is resolved. With the scheduler approach, any compactor assigned to a given tenant can pick up any work required.</p><p><img src=/images/proposals/parallel-compaction-without-scheduler.png alt="Parallel Compaction Without Scheduler"></p><h2 id=scenarios>Scenarios</h2><h3 id=bad-block-resulting-in-non-ideal-compaction-groups>Bad block resulting in non-ideal compaction groups</h3><p>A Cortex operator configures the compaction block range as 2h and 6h. If a full 6-hour block cannot be compacted due to compaction failures, the compactor should not split up the group into subgroups, as this may cause suboptimal grouping of block. Cortex has full information regarding all the available blocks, so we should utilize this information to achieve the best compaction group possible.</p><h2 id=alternatives>Alternatives</h2><h3 id=shard-compaction-jobs-amongst-compactors-with-a-scheduler>Shard compaction jobs amongst compactors with a scheduler</h3><p><img src=/images/proposals/parallel-compaction-design.png alt="Parallel Compaction Architecture"></p><p>We add a new component Compactor Scheduler, which is responsible for calculating the compaction plan, and distributing compaction groups to compactors. The planner is sharded by tenant id, so that we can horizontally scale the planner as needed in order to accept more tenants in the cortex cluster. A tenant will have two queues inside the planner, a compaction queue and a clean up queue, similar to how the query frontend currently holds queues of pending queries.</p><p>Once a compactor scheduler pushes a job to a compactor, the job is no longer available. Every set interval, or once the compaction is done, a compactor will update the compactor schedule the current status of the compaction job. If a compactor does not provide an update to the scheduler within a timeout, the compaction job becomes available to be assigned to other compactors.</p><h4 id=concurrency>Concurrency</h4><p>To achieve concurrency within a single tenant, compactor scheduler will push jobs to compactors. Compactors are shuffle-sharded by tenant id, to prevent a large tenant from impacting the compaction of other tenants. Compactor will download blocks from long term storage, compact, and upload. Compactor will also pull from the clean up queues from scheduler, and delete blocks marked for deletion.</p><h4 id=consistency>Consistency</h4><p>On resharding of compactor schedulers, a tenant might move to a different scheduler. We can either drop the current compactor job in order to prevent duplicate compaction jobs, or continue compaction. I propose that the compactor drops the compaction job if the compaction group no longer belongs to the original compactor scheduler. This way, we do not have duplicate compactions happening, and we can minimize work wasted.</p><h3 id=contribute-to-thanos-for-a-more-scalable-compactor>Contribute to Thanos for a more scalable compactor</h3><p>Instead of introducing parallelism on the Cortex compactor level, we move the parallelism to the Thanos compactor itself. Thanos has a <a href=https://docs.google.com/document/d/1xi0V8DB0hE54XgkogJRnNL6yH7C5JThJywlLFoC6dCQ/>proposal to make compactor more scalable</a>, and a <a href=https://github.com/thanos-io/thanos/pull/3807>PR</a>. Cortex will enjoy higher throughput per tenant if Thanos is able to speed up the compaction, and we can keep the Cortex architecture the same. However, this approach means that a single tenant is still sharded to a single compactor. In order to compact more groups at once, we must scale up compactor vertically. Although vertical scaling can get us far, we should scale horizontally where we can.</p><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT+HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>